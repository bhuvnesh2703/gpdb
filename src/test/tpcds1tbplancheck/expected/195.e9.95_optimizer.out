-- start query 1 in stream 0 using template query95.tpl
explain
with ws_wh as
(select ws1.ws_order_number,ws1.ws_warehouse_sk wh1,ws2.ws_warehouse_sk wh2
 from web_sales ws1,web_sales ws2
 where ws1.ws_order_number = ws2.ws_order_number
   and ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)
 select  
   count(distinct ws_order_number) as "order count"
  ,sum(ws_ext_ship_cost) as "total shipping cost"
  ,sum(ws_net_profit) as "total net profit"
from
   web_sales ws1
  ,date_dim
  ,customer_address
  ,web_site
where
    d_date between '1999-5-01' and 
           (cast('1999-5-01' as date) + 60 )
and ws1.ws_ship_date_sk = d_date_sk
and ws1.ws_ship_addr_sk = ca_address_sk
and ca_state = 'TX'
and ws1.ws_web_site_sk = web_site_sk
and web_company_name = 'pri'
and ws1.ws_order_number in (select ws_order_number
                            from ws_wh)
and ws1.ws_order_number in (select wr_order_number
                            from web_returns,ws_wh
                            where wr_order_number = ws_wh.ws_order_number)
order by count(distinct ws_order_number)
limit 100;
                                                                                                QUERY PLAN                                                                                                 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Gather Motion 3:1  (slice10; segments: 3)  (cost=0.00..3000174.22 rows=1 width=24)
   Merge Key: (count(DISTINCT web_sales.ws_order_number))
   ->  Sort  (cost=0.00..3000174.22 rows=1 width=24)
         Sort Key: (count(DISTINCT web_sales.ws_order_number))
         ->  Sequence  (cost=0.00..3000174.22 rows=1 width=24)
               ->  Shared Scan (share slice:id 10:0)  (cost=0.00..538275.76 rows=4104561812 width=1)
                     ->  Materialize  (cost=0.00..538275.76 rows=4104561812 width=1)
                           ->  Hash Join  (cost=0.00..534171.20 rows=4104561812 width=12)
                                 Hash Cond: (web_sales_1.ws_order_number = web_sales_2.ws_order_number)
                                 Join Filter: (web_sales_1.ws_warehouse_sk <> web_sales_2.ws_warehouse_sk)
                                 ->  Redistribute Motion 3:3  (slice8; segments: 3)  (cost=0.00..34239.80 rows=240000000 width=8)
                                       Hash Key: web_sales_1.ws_order_number
                                       ->  Sequence  (cost=0.00..22739.00 rows=240000000 width=8)
                                             ->  Partition Selector for web_sales (dynamic scan id: 1)  (cost=10.00..100.00 rows=34 width=4)
                                                   Partitions selected: 80 (out of 80)
                                             ->  Dynamic Table Scan on web_sales web_sales_1 (dynamic scan id: 1)  (cost=0.00..22739.00 rows=240000000 width=8)
                                 ->  Hash  (cost=34239.80..34239.80 rows=240000000 width=8)
                                       ->  Redistribute Motion 3:3  (slice9; segments: 3)  (cost=0.00..34239.80 rows=240000000 width=8)
                                             Hash Key: web_sales_2.ws_order_number
                                             ->  Sequence  (cost=0.00..22739.00 rows=240000000 width=8)
                                                   ->  Partition Selector for web_sales (dynamic scan id: 2)  (cost=10.00..100.00 rows=34 width=4)
                                                         Partitions selected: 80 (out of 80)
                                                   ->  Dynamic Table Scan on web_sales web_sales_2 (dynamic scan id: 2)  (cost=0.00..22739.00 rows=240000000 width=8)
               ->  Redistribute Motion 1:3  (slice7)  (cost=0.00..2461898.46 rows=1 width=24)
                     ->  Limit  (cost=0.00..2461898.46 rows=1 width=24)
                           ->  Sort  (cost=0.00..2461898.46 rows=1 width=24)
                                 Sort Key: (count(DISTINCT web_sales.ws_order_number))
                                 ->  Aggregate  (cost=0.00..2461898.46 rows=1 width=24)
                                       ->  Gather Motion 3:1  (slice6; segments: 3)  (cost=0.00..2461897.60 rows=60914 width=14)
                                             ->  Hash Join  (cost=0.00..2461894.43 rows=20305 width=14)
                                                   Hash Cond: (share0_ref3.ws_order_number = web_sales.ws_order_number)
                                                   ->  HashAggregate  (cost=0.00..534416.73 rows=14033167 width=4)
                                                         Group Key: share0_ref3.ws_order_number
                                                         ->  Shared Scan (share slice:id 6:0)  (cost=0.00..39998.98 rows=4104561812 width=4)
                                                   ->  Hash  (cost=1924995.07..1924995.07 rows=20305 width=14)
                                                         ->  Hash Join  (cost=0.00..1924995.07 rows=20305 width=14)
                                                               Hash Cond: (web_returns.wr_order_number = web_sales.ws_order_number)
                                                               ->  HashAggregate  (cost=0.00..1834053.34 rows=10850120 width=4)
                                                                     Group Key: web_returns.wr_order_number
                                                                     ->  Hash Join  (cost=0.00..988542.06 rows=7019518177 width=4)
                                                                           Hash Cond: (web_returns.wr_order_number = share0_ref2.ws_order_number)
                                                                           ->  Redistribute Motion 3:3  (slice1; segments: 3)  (cost=0.00..2695.56 rows=23999168 width=4)
                                                                                 Hash Key: web_returns.wr_order_number
                                                                                 ->  Sequence  (cost=0.00..2120.54 rows=23999168 width=4)
                                                                                       ->  Partition Selector for web_returns (dynamic scan id: 4)  (cost=10.00..100.00 rows=34 width=4)
                                                                                             Partitions selected: 80 (out of 80)
                                                                                       ->  Dynamic Table Scan on web_returns (dynamic scan id: 4)  (cost=0.00..2120.54 rows=23999168 width=4)
                                                                           ->  Hash  (cost=39998.98..39998.98 rows=4104561812 width=4)
                                                                                 ->  Shared Scan (share slice:id 6:0)  (cost=0.00..39998.98 rows=4104561812 width=4)
                                                               ->  Hash  (cost=89017.59..89017.59 rows=26262 width=14)
                                                                     ->  Redistribute Motion 3:3  (slice5; segments: 3)  (cost=0.00..89017.59 rows=26262 width=14)
                                                                           Hash Key: web_sales.ws_order_number
                                                                           ->  Hash Join  (cost=0.00..89016.44 rows=26262 width=14)
                                                                                 Hash Cond: (web_sales.ws_web_site_sk = web_site.web_site_sk)
                                                                                 ->  Hash Join  (cost=0.00..88553.91 rows=163627 width=18)
                                                                                       Hash Cond: (web_sales.ws_ship_date_sk = date_dim.d_date_sk)
                                                                                       ->  Hash Join  (cost=0.00..87164.46 rows=5050082 width=22)
                                                                                             Hash Cond: (web_sales.ws_ship_addr_sk = customer_address.ca_address_sk)
                                                                                             ->  Sequence  (cost=0.00..22739.00 rows=240000000 width=26)
                                                                                                   ->  Partition Selector for web_sales (dynamic scan id: 3)  (cost=10.00..100.00 rows=34 width=4)
                                                                                                         Partitions selected: 80 (out of 80)
                                                                                                   ->  Dynamic Table Scan on web_sales (dynamic scan id: 3)  (cost=0.00..22739.00 rows=240000000 width=26)
                                                                                             ->  Hash  (cost=656.24..656.24 rows=114309 width=4)
                                                                                                   ->  Broadcast Motion 3:3  (slice2; segments: 3)  (cost=0.00..656.24 rows=114309 width=4)
                                                                                                         ->  Table Scan on customer_address  (cost=0.00..648.05 rows=38103 width=4)
                                                                                                               Filter: ((ca_state)::text = 'TX'::text)
                                                                                       ->  Hash  (cost=433.76..433.76 rows=63 width=4)
                                                                                             ->  Broadcast Motion 3:3  (slice3; segments: 3)  (cost=0.00..433.76 rows=63 width=4)
                                                                                                   ->  Table Scan on date_dim  (cost=0.00..433.76 rows=21 width=4)
                                                                                                         Filter: ((d_date >= '05-01-1999'::date) AND (d_date <= '06-30-1999'::date))
                                                                                 ->  Hash  (cost=431.00..431.00 rows=9 width=4)
                                                                                       ->  Broadcast Motion 3:3  (slice4; segments: 3)  (cost=0.00..431.00 rows=9 width=4)
                                                                                             ->  Table Scan on web_site  (cost=0.00..431.00 rows=3 width=4)
                                                                                                   Filter: ((web_company_name)::text = 'pri'::text)
 Planning time: 3693.801 ms
 Optimizer: PQO version 3.8.0
(76 rows)

-- end query 1 in stream 0 using template query95.tpl
